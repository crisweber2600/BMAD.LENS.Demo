# ============================================================================
# LENS Workbench — Discovery Scan Report
# Project: bmad-chat
# Generated: 2026-02-07
# Phase: DS (Discovery Scan)
# Agent: SCOUT
# ============================================================================

project_name: bmad-chat
project_display_name: "BMAD - Business Model Architecture Design Platform"
project_path: TargetProjects/BMAD/CHAT/bmad-chat
control_repo_relative_path: TargetProjects/BMAD/CHAT/bmad-chat
git_branch: main
git_remote: origin
last_commit: "7265921 — Generated by Spark: Fix all reported errors."
total_commits_sampled: 5
origin_tool: "GitHub Spark"
spark_meta:
  template_version: 1
  db_type: kv
  app_id: "839ccf25c4bddabf1a49"

# ============================================================================
# TECHNOLOGY STACK
# ============================================================================
tech_stack:
  language: TypeScript
  language_version: "~5.7.2"
  target: ES2020
  module_system: ESNext
  jsx: react-jsx
  framework: React
  framework_version: "^19.0.0"
  runtime: Browser (SPA)
  bundler: Vite
  bundler_version: "^7.2.6"
  bundler_plugin: "@vitejs/plugin-react-swc"
  css_framework: Tailwind CSS
  css_version: "^4.1.11"
  ui_component_library: "shadcn/ui (Radix primitives + Tailwind, new-york style)"
  icon_libraries:
    - "@phosphor-icons/react ^2.1.7"
    - "lucide-react ^0.484.0"
    - "@heroicons/react ^2.2.0"
  state_management: "React hooks + GitHub Spark KV (useKV)"
  data_fetching: "@tanstack/react-query ^5.83.1"
  form_handling: "react-hook-form ^7.54.2 + @hookform/resolvers ^4.1.3 + zod ^3.25.76"
  charts: "recharts ^2.15.1"
  3d_graphics: "three ^0.175.0"
  animation: "framer-motion ^12.6.2"
  markdown: "marked ^15.0.7"
  date_utils: "date-fns ^3.6.0"
  carousel: "embla-carousel-react ^8.5.2"
  linting: "eslint ^9.28.0 + typescript-eslint ^8.38.0"
  fonts:
    - "Space Grotesk (400-700)"
    - "JetBrains Mono (400-500)"

  platform_integration:
    name: "GitHub Spark"
    package: "@github/spark >=0.43.1 <1"
    features:
      - "spark-vite-plugin (build integration)"
      - "Phosphor icon proxy plugin"
      - "window.spark.kv (key-value persistence)"
      - "window.spark.llm (LLM inference)"
      - "useKV hook (reactive KV state)"

# ============================================================================
# ARCHITECTURE PATTERN
# ============================================================================
architecture_pattern:
  type: "Single Page Application (SPA)"
  component_model: "React functional components with hooks"
  state_pattern: "Custom hooks wrapping Spark KV for persistence"
  service_layer: "Static class methods (ChatService, PRService, AIService, LineCommentService)"
  data_persistence: "GitHub Spark KV store (browser-side, key-value)"
  authentication: "Custom email/password stored in Spark KV (no external auth provider)"
  real_time: "Polling-based presence via Spark KV (CollaborationService)"
  routing: "No client-side router — conditional rendering in monolithic App.tsx"
  error_handling: "react-error-boundary with ErrorFallback component"
  theming: "next-themes + Radix colors + custom CSS variables (neutral/accent/accent-secondary)"
  api_spec: "OpenAPI 3.1.0 (1804 lines) — describes intended REST API, not yet implemented as backend"

  key_patterns:
    - "Monolithic App.tsx (661 lines) — all routing, layout, and state wiring"
    - "Hook-per-domain: useAuth, useChats, usePullRequests, usePendingChanges, useCollaboration, useUIState, useChatActions"
    - "Service classes with static methods — pure data transforms, no side effects"
    - "Spark KV as database — useKV('key', default) pattern for reactive state"
    - "window.spark.llm for AI chat responses and role-based translation"
    - "ID generation via timestamp: `type-${Date.now()}`"
    - "Component-per-feature: AuthForm, ChatList, ChatMessage, PRDialog, MomentumDashboard, etc."
    - "shadcn/ui primitives in src/components/ui/ (46 components)"

# ============================================================================
# FILE INVENTORY
# ============================================================================
file_inventory:
  total_source_files: 94
  total_lines_of_code: 10615
  lines_application_code: 5559
  lines_ui_primitives: 5056
  disk_usage_src: "485K"

  by_extension:
    tsx: 71
    ts: 20
    css: 3

  by_category:
    application_components: 21
    ui_primitive_components: 46
    custom_hooks: 8
    services: 5  # includes index.ts barrel
    lib_utilities: 5  # types, auth, collaboration, constants, utils
    entry_points: 2  # main.tsx, App.tsx
    style_files: 3  # main.css, index.css, theme.css
    type_declarations: 2  # vite-env.d.ts, vite-end.d.ts
    deprecated: 1  # App.refactored.tsx
    error_handling: 1  # ErrorFallback.tsx

# ============================================================================
# KEY FILES
# ============================================================================
key_files:
  entry_point: src/main.tsx
  root_component: src/App.tsx
  type_definitions: src/lib/types.ts
  authentication: src/lib/auth.ts
  collaboration_engine: src/lib/collaboration.ts
  constants: src/lib/constants.ts
  utilities: src/lib/utils.ts
  error_boundary: src/ErrorFallback.tsx
  deprecated_placeholder: src/App.refactored.tsx

  config_files:
    - package.json
    - tsconfig.json
    - vite.config.ts
    - tailwind.config.js
    - components.json         # shadcn/ui config
    - theme.json              # empty — theme uses CSS variables
    - runtime.config.json     # Spark runtime config (app ID)
    - spark.meta.json         # Spark template metadata (kv db type)
    - openapi.yaml            # OpenAPI 3.1.0 spec (1804 lines)
    - .github/dependabot.yml  # Dependabot config

  documentation:
    - README.md               # Project overview, architecture, features
    - PRD.md                  # Product Requirements Document
    - REFACTORING.md          # Refactoring notes
    - SECURITY.md             # Security considerations
    - API-README.md           # API documentation
    - LICENSE                 # License file

# ============================================================================
# SOURCE STRUCTURE
# ============================================================================
source_structure:
  src/:
    main.tsx: "App bootstrap — renders <App> inside ErrorBoundary"
    App.tsx: "Monolithic root — 661 lines, all state wiring, layout, routing"
    App.refactored.tsx: "DEPRECATED placeholder (8 lines)"
    ErrorFallback.tsx: "Error boundary fallback UI (41 lines)"
    vite-env.d.ts: "Vite type declarations"
    vite-end.d.ts: "Vite type declarations"
    index.css: "Global styles"
    main.css: "Main stylesheet (Tailwind imports)"

    components/:
      _count: 21
      _description: "Feature components — one per UI concern"
      AuthForm.tsx: "Sign in/up form with role selection (180 lines)"
      ChatList.tsx: "Chat conversation list sidebar (246 lines)"
      ChatMessage.tsx: "Individual message bubble (103 lines)"
      ChatInput.tsx: "Message input with typing indicator (93 lines)"
      MomentumDashboard.tsx: "Project health/velocity dashboard (324 lines)"
      PRCard.tsx: "Pull request summary card (79 lines)"
      PRDialog.tsx: "PR detail dialog with comments (226 lines)"
      CreatePRDialog.tsx: "New PR creation form (115 lines)"
      FileDiffViewer.tsx: "Side-by-side file diff viewer (158 lines)"
      FilePreviewDialog.tsx: "Full file preview modal (466 lines)"
      AllFilesPreviewDialog.tsx: "Multi-file preview (57 lines)"
      InlineCommentThread.tsx: "Line-level code comments (255 lines)"
      ActiveUsers.tsx: "Online presence indicators (88 lines)"
      TypingIndicator.tsx: "Typing bubble animation (64 lines)"
      ActivityFeed.tsx: "Collaboration event feed (88 lines)"
      NewChatDialog.tsx: "New chat creation dialog (176 lines)"
      DocumentTranslationView.tsx: "Role-based document translation UI (259 lines)"
      TranslateButton.tsx: "Translation trigger button (61 lines)"
      TranslatedText.tsx: "Translated content display (100 lines)"
      EmojiReactionPicker.tsx: "Emoji selector popover (50 lines)"
      EmojiReactionsDisplay.tsx: "Reaction count badges (52 lines)"

      ui/:
        _count: 46
        _description: "shadcn/ui Radix-based primitives (new-york style)"
        _components: ["accordion", "alert", "alert-dialog", "aspect-ratio", "avatar",
          "badge", "breadcrumb", "button", "calendar", "card", "carousel", "chart",
          "checkbox", "collapsible", "command", "context-menu", "dialog", "drawer",
          "dropdown-menu", "form", "hover-card", "input", "input-otp", "label",
          "menubar", "navigation-menu", "pagination", "popover", "progress",
          "radio-group", "resizable", "scroll-area", "select", "separator", "sheet",
          "sidebar", "skeleton", "slider", "sonner", "switch", "table", "tabs",
          "textarea", "toggle", "toggle-group", "tooltip"]

    hooks/:
      _count: 8
      _description: "Custom React hooks — one per domain"
      use-auth.ts: "Authentication state + sign in/up/out (91 lines)"
      use-chats.ts: "Chat CRUD + message management via Spark KV (157 lines)"
      use-chat-actions.ts: "Send message, translate, typing coordination (53 lines)"
      use-pull-requests.ts: "PR lifecycle via Spark KV (148 lines)"
      use-pending-changes.ts: "Uncommitted file changes tracking (74 lines)"
      use-collaboration.ts: "Presence, typing, events via CollaborationService (116 lines)"
      use-ui-state.ts: "Panel visibility, active chat, navigation (80 lines)"
      use-mobile.ts: "Responsive breakpoint detection (19 lines)"

    lib/:
      _description: "Shared logic, types, services"
      types.ts: "All TypeScript interfaces — User, Chat, Message, PullRequest, etc. (135 lines)"
      auth.ts: "Auth functions using Spark KV (62 lines)"
      collaboration.ts: "CollaborationService class — presence, typing, events (146 lines)"
      constants.ts: "App constants, route keys, panel breakpoints, timing (24 lines)"
      utils.ts: "cn() Tailwind merge utility (6 lines)"

      services/:
        _count: 5
        _description: "Static service classes — pure data transforms"
        index.ts: "Barrel export (4 lines)"
        ai.service.ts: "LLM prompt construction + response parsing (112 lines)"
        chat.service.ts: "Chat/Message factory methods (64 lines)"
        pr.service.ts: "PR lifecycle factory methods (77 lines)"
        line-comment.service.ts: "Line comment CRUD + reactions (201 lines)"

    styles/:
      theme.css: "CSS custom properties for theming"

# ============================================================================
# DEPENDENCIES
# ============================================================================
dependencies:
  production:
    platform:
      - "@github/spark >=0.43.1 <1"
    react_core:
      - "react ^19.0.0"
      - "react-dom ^19.0.0"
      - "react-error-boundary ^6.0.0"
    ui_primitives_radix:
      - "@radix-ui/react-accordion ^1.2.3"
      - "@radix-ui/react-alert-dialog ^1.1.6"
      - "@radix-ui/react-aspect-ratio ^1.1.2"
      - "@radix-ui/react-avatar ^1.1.3"
      - "@radix-ui/react-checkbox ^1.1.4"
      - "@radix-ui/react-collapsible ^1.1.3"
      - "@radix-ui/react-context-menu ^2.2.6"
      - "@radix-ui/react-dialog ^1.1.6"
      - "@radix-ui/react-dropdown-menu ^2.1.6"
      - "@radix-ui/react-hover-card ^1.1.6"
      - "@radix-ui/react-label ^2.1.2"
      - "@radix-ui/react-menubar ^1.1.6"
      - "@radix-ui/react-navigation-menu ^1.2.5"
      - "@radix-ui/react-popover ^1.1.6"
      - "@radix-ui/react-progress ^1.1.2"
      - "@radix-ui/react-radio-group ^1.2.3"
      - "@radix-ui/react-scroll-area ^1.2.9"
      - "@radix-ui/react-select ^2.1.6"
      - "@radix-ui/react-separator ^1.1.2"
      - "@radix-ui/react-slider ^1.3.6"
      - "@radix-ui/react-slot ^1.1.2"
      - "@radix-ui/react-switch ^1.1.3"
      - "@radix-ui/react-tabs ^1.1.3"
      - "@radix-ui/react-toggle ^1.1.2"
      - "@radix-ui/react-toggle-group ^1.1.2"
      - "@radix-ui/react-tooltip ^1.1.8"
      - "@radix-ui/colors ^3.0.0"
    styling:
      - "tailwind-merge ^3.0.2"
      - "class-variance-authority ^0.7.1"
      - "clsx ^2.1.1"
      - "tw-animate-css ^1.2.4"
      - "@tailwindcss/container-queries ^0.1.1"
      - "@tailwindcss/vite ^4.1.11"
      - "next-themes ^0.4.6"
    data_viz:
      - "recharts ^2.15.1"
      - "d3 ^7.9.0"
      - "three ^0.175.0"
    forms:
      - "react-hook-form ^7.54.2"
      - "@hookform/resolvers ^4.1.3"
      - "zod ^3.25.76"
      - "input-otp ^1.4.2"
    github_integration:
      - "@octokit/core ^6.1.4"
      - "octokit ^4.1.2"
    ui_extras:
      - "framer-motion ^12.6.2"
      - "cmdk ^1.1.1"
      - "embla-carousel-react ^8.5.2"
      - "lucide-react ^0.484.0"
      - "@phosphor-icons/react ^2.1.7"
      - "@heroicons/react ^2.2.0"
      - "react-day-picker ^9.6.7"
      - "react-resizable-panels ^2.1.7"
      - "sonner ^2.0.1"
      - "vaul ^1.1.2"
    utilities:
      - "date-fns ^3.6.0"
      - "marked ^15.0.7"
      - "uuid ^11.1.0"
    state:
      - "@tanstack/react-query ^5.83.1"

  dev:
    - "@eslint/js ^9.21.0"
    - "@tailwindcss/postcss ^4.1.8"
    - "@types/react ^19.0.10"
    - "@types/react-dom ^19.0.4"
    - "@vitejs/plugin-react-swc ^4.2.2"
    - "eslint ^9.28.0"
    - "eslint-plugin-react-hooks ^5.2.0"
    - "eslint-plugin-react-refresh ^0.4.19"
    - "globals ^16.0.0"
    - "tailwindcss ^4.1.11"
    - "typescript ~5.7.2"
    - "typescript-eslint ^8.38.0"
    - "vite ^7.2.6"

  total_production: 56
  total_dev: 13

# ============================================================================
# DATA MODEL
# ============================================================================
data_model:
  persistence: "GitHub Spark KV (key-value store, browser-side)"
  kv_keys:
    - "docflow-users → AuthUser[]"
    - "docflow-current-user → AuthUser"
    - "chats → Chat[]"
    - "pull-requests → PullRequest[]"
    - "pending-changes → FileChange[]"
    - "user-presence → Record<string, UserPresence>"
    - "collaboration-events → CollaborationEvent[]"

  entities:
    User:
      fields: [id, name, avatarUrl, role, email, password?]
      notes: "Runtime user representation"
    AuthUser:
      fields: [id, email, password, name, role, avatarUrl, createdAt]
      notes: "Persisted auth record"
    UserPresence:
      fields: [userId, userName, avatarUrl, activeChat, lastSeen, isTyping, typingChatId, cursorPosition?]
    Chat:
      fields: [id, title, createdAt, updatedAt, messages, participants, domain?, service?, feature?]
      notes: "Domain/Service/Feature taxonomy for chat organization"
    Message:
      fields: [id, chatId, content, role, timestamp, userId?, fileChanges?, translations?]
    MessageTranslation:
      fields: [role, segments]
    TranslatedSegment:
      fields: [originalText, startIndex, endIndex, explanation, context, simplifiedText?]
    EmojiReaction:
      fields: [emoji, userIds, userNames]
    LineComment:
      fields: [id, fileId, lineNumber, lineType, author, authorAvatar, content, timestamp, resolved, replies?, reactions?]
    FileChange:
      fields: [path, additions, deletions, status, lineComments?]
    PullRequest:
      fields: [id, title, description, chatId, author, status, createdAt, updatedAt, fileChanges, comments, approvals]
    PRComment:
      fields: [id, prId, author, content, timestamp]
    CollaborationEvent:
      fields: [id, type, userId, userName, chatId?, prId?, timestamp, metadata?]

# ============================================================================
# INITIAL OBSERVATIONS
# ============================================================================
initial_observations:
  strengths:
    - "Rich feature set: chat, PR workflow, code review, AI translation, presence, dashboard"
    - "Clean hook-per-domain separation — each domain concern in its own hook"
    - "Service layer uses static methods — easily testable pure functions"
    - "Comprehensive OpenAPI spec (1804 lines) documents intended API surface"
    - "Modern stack: React 19, Vite 7, Tailwind 4, TypeScript 5.7"
    - "Full shadcn/ui component library (46 primitives) for consistent design"
    - "Type safety: all entities defined in types.ts with TypeScript interfaces"
    - "Product documentation exists: PRD.md, README.md, SECURITY.md, REFACTORING.md"

  concerns:
    - "MONOLITHIC App.tsx (661 lines): All routing, layout, state wiring in single file — needs decomposition"
    - "NO CLIENT-SIDE ROUTER: Navigation is conditional rendering, not URL-based routes"
    - "NO BACKEND: All data persists in Spark KV (browser-local) — no server, no database"
    - "PASSWORDS IN PLAINTEXT: Auth stores passwords unhashed in Spark KV"
    - "NO TESTS: Zero test files found — no unit, integration, or e2e tests"
    - "ID COLLISION RISK: IDs use Date.now() — concurrent creates can collide"
    - "3 ICON LIBRARIES: Phosphor, Lucide, and Heroicons all in dependencies — should consolidate"
    - "UNUSED DEPENDENCIES: three.js, d3, octokit present but usage unclear/minimal"
    - "DEPRECATED FILE: App.refactored.tsx is a dead placeholder — should be removed"
    - "EMPTY THEME: theme.json is {} — no custom theme values"
    - "AI SERVICE TIGHTLY COUPLED: Uses window.spark.llm directly — not abstractable for backend migration"
    - "PRESENCE IS POLLING: CollaborationService polls KV every 5s — not true real-time"

  opportunities:
    - "BACKEND MIGRATION: OpenAPI spec exists as blueprint for bmadServer (.NET Aspire) backend"
    - "ROUTE DECOMPOSITION: Extract App.tsx into page components with React Router"
    - "AUTH HARDENING: Move to backend auth with hashed passwords and JWT tokens"
    - "TEST INFRASTRUCTURE: Add Vitest + React Testing Library for unit/component tests"
    - "ICON CONSOLIDATION: Standardize on one icon library (Phosphor recommended per Spark)"
    - "REAL-TIME: Replace KV polling with WebSocket/SSE when backend is available"
    - "CODE SPLITTING: Vite lazy imports for route-level code splitting"
    - "DEPENDENCY AUDIT: Review three.js, d3, octokit for actual usage; remove if unused"
    - "STATE MANAGEMENT: Consider Zustand or Jotai to reduce prop drilling from App.tsx"

  migration_notes:
    target_backend: "bmadServer (TargetProjects/BMAD/CHAT/bmadServer) — .NET Aspire"
    openapi_spec: "openapi.yaml (1804 lines) — defines REST endpoints for all features"
    spark_kv_to_api: "All useKV hooks need migration to API calls via @tanstack/react-query"
    spark_llm_to_api: "window.spark.llm calls need proxy through backend AI service"
    auth_migration: "Spark KV auth → backend JWT auth (partially started per prior work)"
    compatibility_layer: "SparkCompat controllers exist in bmadServer for gradual migration"
