---
name: pr-links
description: PR URL standards, generation patterns, and review integration for lens-work
type: include
---

# PR Links Reference

This document defines PR URL generation patterns for supported git hosting platforms, validation rules, and review integration.

---

## Supported Platforms

| Platform | Detection Pattern | PR Creation URL Format |
|----------|-------------------|------------------------|
| GitHub | `github.com` in remote URL | `https://github.com/{org}/{repo}/compare/{target}...{source}` |
| GitLab | `gitlab.com` in remote URL | `https://gitlab.com/{org}/{repo}/-/merge_requests/new?source_branch={source}&target_branch={target}` |
| Azure DevOps | `dev.azure.com` in remote URL | `https://dev.azure.com/{org}/{project}/_git/{repo}/pullrequestcreate?sourceRef={source}&targetRef={target}` |

---

## URL Generation

### Detect Remote Type

```bash
remote_url=$(git remote get-url origin)

if [[ "$remote_url" == *"github.com"* ]]; then
  remote_type="github"
elif [[ "$remote_url" == *"gitlab.com"* ]]; then
  remote_type="gitlab"
elif [[ "$remote_url" == *"dev.azure.com"* ]]; then
  remote_type="azdo"
else
  remote_type="unknown"
fi
```

### Extract Org/Repo

```bash
# GitHub HTTPS: https://github.com/org/repo.git
# GitHub SSH:   git@github.com:org/repo.git
if [[ "$remote_url" == https://* ]]; then
  org=$(echo "$remote_url" | sed -E 's|https://[^/]+/([^/]+)/.*|\1|')
  repo=$(echo "$remote_url" | sed -E 's|https://[^/]+/[^/]+/([^/.]+).*|\1|')
elif [[ "$remote_url" == git@* ]]; then
  org=$(echo "$remote_url" | sed -E 's|git@[^:]+:([^/]+)/.*|\1|')
  repo=$(echo "$remote_url" | sed -E 's|git@[^:]+:[^/]+/([^/.]+).*|\1|')
fi
```

### Generate PR URL

```bash
generate_pr_url() {
  local source_branch="$1"
  local target_branch="$2"

  case "$remote_type" in
    github)
      echo "https://github.com/${org}/${repo}/compare/${target_branch}...${source_branch}"
      ;;
    gitlab)
      echo "https://gitlab.com/${org}/${repo}/-/merge_requests/new?source_branch=${source_branch}&target_branch=${target_branch}"
      ;;
    azdo)
      echo "https://dev.azure.com/${org}/${project}/_git/${repo}/pullrequestcreate?sourceRef=${source_branch}&targetRef=${target_branch}"
      ;;
    *)
      echo "MANUAL: Create PR from ${source_branch} → ${target_branch}"
      ;;
  esac
}
```

---

## PR Scenarios in lens-work

| Scenario | Source Branch | Target Branch | Generated By |
|----------|-------------|---------------|--------------|
| Finish workflow | `{Domain}/{id}/{size}-{N}-{name}` | `{Domain}/{id}/{size}-{N}` | `finish-workflow` |
| Finish phase | `{Domain}/{id}/{size}-{N}` | `{Domain}/{id}/{size}` | `finish-phase` |
| Large review ¹ | `{Domain}/{id}/small` | `{Domain}/{id}/large` | `finish-phase` (step: open-large-review) |
| Final PBR | `{Domain}/{id}/large` | `{Domain}/{id}/base` | `finish-phase` (gate: review-gate) |

¹ **Large review PR:** Opened automatically by `finish-phase` when completing P2 (Planning phase) on the small size. Requires lead/architect approval before merging to base.

---

## Validation Rules

Before generating a PR link, validate:

```bash
validate_pr_prerequisites() {
  local source="$1"
  local target="$2"

  # 1. Source branch exists on remote
  if ! git ls-remote --exit-code origin "$source" > /dev/null 2>&1; then
    echo "❌ Source branch not found on remote: $source"
    return 1
  fi

  # 2. Target branch exists on remote
  if ! git ls-remote --exit-code origin "$target" > /dev/null 2>&1; then
    echo "❌ Target branch not found on remote: $target"
    return 1
  fi

  # 3. Source has commits ahead of target
  ahead=$(git rev-list --count "origin/${target}..origin/${source}")
  if [ "$ahead" -eq 0 ]; then
    echo "⚠️ No new commits in source. PR would be empty."
    return 1
  fi

  echo "✅ PR prerequisites met (${ahead} commits ahead)"
  return 0
}
```

---

## PR Description Template

When generating PR links, include a suggested PR description body:

### Workflow PR (workflow → phase)

```markdown
## Workflow: {workflow_name}

**Initiative:** {initiative_id}
**Phase:** P{phase_number} — {phase_name}
**Size:** {size}

### Changes

{auto-generated from commit messages}

### Checklist

- [ ] Artifacts committed and complete
- [ ] State updated
- [ ] Event log entry appended
- [ ] Ready for next workflow
```

### Phase PR (phase → size)

```markdown
## Phase Complete: P{phase_number} — {phase_name}

**Initiative:** {initiative_id}
**Size:** {size}

### Artifacts Produced

{list of artifacts created in this phase}

### Gate Status

- Phase gate: {status}
- Artifacts validated: {count}

### Next Phase

Ready for P{next_phase_number} — {next_phase_name}
```

### Large Review PR (small → large)

```markdown
## Large Review: {initiative_name}

**Initiative:** {initiative_id}
**Requested by:** {actor}

### Planning Artifacts for Review

- [ ] Product Brief (P1)
- [ ] PRD (P2)
- [ ] UX Design (P2)
- [ ] Architecture (P2)
- [ ] Epics & Stories (P3)
- [ ] Readiness Checklist (P3)

### Review Focus

{reviewer instructions}
```

---

## Related Includes

- **size-topology.md** — Branch naming patterns used in PR source/target
- **gate-event-template.md** — Gate events linked to PR approvals
