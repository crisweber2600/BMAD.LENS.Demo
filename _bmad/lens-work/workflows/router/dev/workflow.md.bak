---
name: dev
description: Implementation loop (dev-story/code-review/retro)
agent: compass
trigger: /dev command
category: router
phase: 4
phase_name: Implementation
---

# /dev â€” Implementation Phase Router

**Purpose:** Guide developers through implementation, constitution-aware adversarial code review, epic-completion teardown, and retrospective.

---

## Role Authorization

**Authorized:** Developer (post-review only)

```yaml
# Dev story check deferred to Step 0 for batch mode support
```

---

## Prerequisites

- [x] `/review` complete
- [x] Dev story exists (interactive mode)
- [x] Developer assigned (or self-assigned)
- [x] state.yaml + initiatives/{id}.yaml exist
- [x] Implementation gate passed (P3 Solutioning complete)

---

## Execution Sequence

### 0. Git Discipline â€” Verify Clean State

```yaml
# Verify working directory is clean
invoke: casey.verify-clean-state

# Load two-file state
state = load("_bmad-output/lens-work/state.yaml")
initiative = load("_bmad-output/lens-work/initiatives/${state.active_initiative}.yaml")

# Read size from initiative config (shared, canonical)
size = initiative.size
domain_prefix = initiative.domain_prefix

# Require dev story for interactive mode
if initiative.question_mode != "batch" and not dev_story_exists():
  error: "/review has not produced a dev-ready story. Run /review first."

# Size validation â€” verify current size allows dev phase
# Dev (P4) must be on small size
if size != "small":
  error: |
    âŒ Size validation failed
    â”œâ”€â”€ Current size: ${size}
    â”œâ”€â”€ Required: small
    â””â”€â”€ Dev phase (P4) only runs on the small size.

# Validate we're on the correct branch (or can switch)
# Branch pattern: {Domain}/{InitiativeId}/{size}-{phaseNumber}
expected_branch: "${domain_prefix}/${initiative.id}/${size}-4"
current_branch = casey.get-current-branch()

if current_branch != expected_branch:
  if branch_exists(expected_branch):
    invoke: casey.checkout-branch
    params:
      branch: ${expected_branch}
    invoke: casey.pull-latest
  # else: branch will be created in Step 1a
```

### 1. Merge Gate Check â€” P3 Complete

```yaml
# Merge gate checking â€” verify P3 (Solutioning) is complete before allowing dev
# Branch pattern: {Domain}/{InitiativeId}/{size}-{phaseNumber}
p3_branch = "${domain_prefix}/${initiative.id}/${size}-3"
size_branch = "${domain_prefix}/${initiative.id}/${size}"

# Ancestry check: P3 must be merged into size branch (or base)
result = casey.exec("git merge-base --is-ancestor origin/${p3_branch} origin/${size_branch}")

if result.exit_code != 0:
  error: |
    âŒ Merge gate blocked
    â”œâ”€â”€ P3 (Solutioning) not merged into size branch
    â”œâ”€â”€ Expected: ${p3_branch} is ancestor of ${size_branch}
    â””â”€â”€ Action: Complete /plan and merge P3 PR first

# Verify implementation gate passed
if initiative.gates.implementation_gate.status not in ["passed", "passed_with_warnings"]:
  error: "Implementation gate not passed. Run /review first."
```

### 1a. Constitutional Context Injection (Required)

```yaml
# Resolve constitutional governance for this context before implementation loop
constitutional_context = invoke("scribe.resolve-context")

if constitutional_context.status == "parse_error":
  error: |
    Constitutional context parse error:
    ${constitutional_context.error_details.file}
    ${constitutional_context.error_details.error}

session.constitutional_context = constitutional_context
```

### 1b. Auto-Branch Creation - P4

```yaml
# Casey creates P4 branch if it doesn't exist
# Branch pattern: {Domain}/{InitiativeId}/{size}-{phaseNumber}
if not branch_exists("${domain_prefix}/${initiative.id}/${size}-4"):
  invoke: casey.start-phase
  params:
    phase_number: 4
    phase_name: "Implementation"
    initiative_id: ${initiative.id}
    size: ${size}
    domain_prefix: ${domain_prefix}
  # Casey creates: ${domain_prefix}/{initiative_id}/{size}-4 and pushes to remote

  invoke: casey.pull-latest
else:
  invoke: casey.checkout-branch
  params:
    branch: "${domain_prefix}/${initiative.id}/${size}-4"
  invoke: casey.pull-latest
```

### 1c. Batch Mode (Single-File Questions)

```yaml
if initiative.question_mode == "batch":
  invoke: lens-work.batch-process
  params:
    phase_number: "4"
    phase_name: "Implementation"
    template_path: "templates/phase-4-implementation-questions.template.md"
    output_filename: "phase-4-implementation-questions.md"
  exit: 0
```

### 2. Load Dev Story

```yaml
dev_story = load("_bmad-output/implementation-artifacts/dev-story-${id}.md")

output: |
  ðŸš€ /dev â€” Implementation Phase
  
  **Story:** ${dev_story.title}
  **Acceptance Criteria:**
  ${dev_story.acceptance_criteria}
  
  **Technical Notes:**
  ${dev_story.technical_notes}
  
  **Branch:** ${domain_prefix}/${initiative.id}/${size}-4
```

### 2a. Dev Story Constitution Check (Required)

```yaml
dev_story_path = "_bmad-output/implementation-artifacts/dev-story-${id}.md"

dev_story_compliance = invoke("scribe.compliance-check")
params:
  artifact_path: ${dev_story_path}
  artifact_type: "Story/Epic"
  constitutional_context: ${constitutional_context}

if dev_story_compliance.fail_count > 0:
  error: |
    Dev story failed constitutional compliance gate.
    FAIL count: ${dev_story_compliance.fail_count}
    Resolve story/compliance issues in /review before implementation.
```

### 3. Checkout Target Repo

**IMPORTANT:** This is where we switch from BMAD control repo to TargetProjects.

```yaml
# Casey checks out the feature branch in the actual repo
invoke: casey.checkout-target
params:
  target_repo: "${initiative.target_repos[0]}"
  target_path: "TargetProjects/${domain}/${service}/${repo}"
  branch: "feature/${story_id}"

output: |
  ðŸ“‚ Target Repo Ready
  â”œâ”€â”€ Repo: ${target_repo}
  â”œâ”€â”€ Path: ${target_path}
  â”œâ”€â”€ Branch: feature/${story_id}
  â””â”€â”€ You can now implement in the target repo
```

### 4. Implementation Guidance

```
ðŸ”§ Implementation Mode

You're now working in: ${target_path}

**Remember:**
- Implement the story in the target repo
- Commit frequently with meaningful messages
- Return to BMAD directory when ready for code review

**Commands available:**
- `@compass done` â€” Signal implementation complete, start code review
- `@tracey ST` â€” Check status
- `@compass help` â€” Show available commands
```

### 5. Adversarial Code Review + Constitutional Gates (when signaled)

```yaml
# User signals: @compass done
invoke: casey.start-workflow
params:
  workflow_name: code-review

# BMM code-review is explicitly adversarial and must challenge implementation claims
invoke: bmm.code-review
params:
  target_repo: "${target_path}"
  branch: "feature/${story_id}"
  constitutional_context: ${constitutional_context}

# Re-check constitutional compliance on review outputs before allowing progression
code_review_path = "_bmad-output/implementation-artifacts/code-review-${id}.md"
code_review_compliance = invoke("scribe.compliance-check")
params:
  artifact_path: ${code_review_path}
  artifact_type: "Code file"
  constitutional_context: ${constitutional_context}

if code_review_compliance.fail_count > 0:
  error: |
    Code review compliance gate failed.
    FAIL count: ${code_review_compliance.fail_count}
    Resolve violations and re-run @compass done.

# Multi-agent teardown pass to aggressively probe edge cases
invoke: core.party-mode
params:
  input_file: ${code_review_path}
  artifacts_path: ${target_path}
  output_file: "_bmad-output/implementation-artifacts/party-mode-review-${story_id}.md"
  constitutional_context: ${constitutional_context}

if party_mode.status not in ["pass", "complete"]:
  error: |
    Party mode teardown found unresolved issues.
    Address _bmad-output/implementation-artifacts/party-mode-review-${story_id}.md and re-run @compass done.

# Epic-level teardown is mandatory when this story completes its parent epic
current_epic_id = resolve_story_epic_id(
  "${story_id}",
  "_bmad-output/planning-artifacts/stories.md",
  ${dev_story_path}
)

if current_epic_id:
  epic_completion = evaluate_epic_completion(
    "${current_epic_id}",
    "_bmad-output/planning-artifacts/stories.md",
    "_bmad-output/implementation-artifacts/"
  )

  if epic_completion.status == "complete":
    epic_adversarial = invoke("bmm.check-implementation-readiness")
    params:
      scope: "epic"
      epic_id: ${current_epic_id}
      stories: "_bmad-output/planning-artifacts/stories.md"
      implementation_artifacts: "_bmad-output/implementation-artifacts/"
      constitutional_context: ${constitutional_context}

    if epic_adversarial.status in ["blocked", "fail", "failed"]:
      error: |
        Epic adversarial review failed for ${current_epic_id}.
        Resolve implementation-readiness findings and re-run @compass done.

    invoke: core.party-mode
    params:
      input_file: "_bmad-output/planning-artifacts/epics.md"
      focus_epic: ${current_epic_id}
      artifacts_path: ${target_path}
      output_file: "_bmad-output/implementation-artifacts/epic-${current_epic_id}-party-mode-review.md"
      constitutional_context: ${constitutional_context}

    if party_mode.status not in ["pass", "complete"]:
      error: |
        Epic party-mode teardown found unresolved issues for ${current_epic_id}.
        Address _bmad-output/implementation-artifacts/epic-${current_epic_id}-party-mode-review.md and re-run @compass done.

invoke: casey.finish-workflow
```

### 6. Retrospective (optional)

```yaml
offer: "Run retrospective? [Y]es / [N]o"

if yes:
  invoke: casey.start-workflow
  params:
    workflow_name: retro
    
  invoke: bmm.retrospective
  params:
    constitutional_context: ${constitutional_context}
  invoke: casey.finish-workflow
```

### 7. Update State Files & Initiative Config

```yaml
# Update initiative file: _bmad-output/lens-work/initiatives/${initiative.id}.yaml
invoke: tracey.update-initiative
params:
  initiative_id: ${initiative.id}
  updates:
    current_phase: "p4"
    current_phase_name: "Implementation"
    phases:
      p4:
        status: "in_progress"
        started_at: "${ISO_TIMESTAMP}"
    gates:
      p3_complete:
        status: "passed"
        verified_at: "${ISO_TIMESTAMP}"
      dev_started:
        status: "in_progress"
        started_at: "${ISO_TIMESTAMP}"
        story_id: "${story_id}"

# Update state.yaml current phase to p4
invoke: tracey.update-state
params:
  updates:
    current_phase: "p4"
    current_phase_name: "Implementation"
    active_branch: "${domain_prefix}/${initiative.id}/${size}-4"
    workflow_status: "in_progress"
```

### 8. Commit State Changes

```yaml
# Casey commits all state and artifact changes
invoke: casey.commit-and-push
params:
  paths:
    - "_bmad-output/lens-work/state.yaml"
    - "_bmad-output/lens-work/initiatives/${initiative.id}.yaml"
    - "_bmad-output/lens-work/event-log.jsonl"
    - "_bmad-output/implementation-artifacts/"
  message: "[lens-work] /dev: Phase 4 Implementation â€” ${initiative.id} â€” ${story_id}"
  branch: "${domain_prefix}/${initiative.id}/${size}-4"
```

### 9. Log Event

```json
{"ts":"${ISO_TIMESTAMP}","event":"dev","id":"${initiative.id}","phase":"p4","workflow":"dev","story":"${story_id}","status":"in_progress"}
```

### 10. Complete Initiative (when all done)

```yaml
if all_phases_complete():
  invoke: tracey.update-initiative
  params:
    initiative_id: ${initiative.id}
    updates:
      status: "complete"
      completed_at: "${ISO_TIMESTAMP}"
      phases:
        p4:
          status: "complete"
          completed_at: "${ISO_TIMESTAMP}"

  invoke: tracey.archive
  
  # Final commit
  invoke: casey.commit-and-push
  params:
    paths:
      - "_bmad-output/lens-work/"
    message: "[lens-work] Initiative complete â€” ${initiative.id}"
  
  output: |
    ðŸŽ‰ Initiative Complete!
    â”œâ”€â”€ All phases finished
    â”œâ”€â”€ Code merged to main
    â”œâ”€â”€ Initiative archived
    â””â”€â”€ Great work, team!
```

---

## Control-Plane Rule Reminder

Throughout `/dev`, the user may work in TargetProjects for actual coding, but all lens-work commands continue to execute from the BMAD directory:

| Action | Location |
|--------|----------|
| Write code | TargetProjects/${repo} |
| Run /dev commands | BMAD directory |
| Code review | BMAD directory |
| Status checks | BMAD directory |

---

## Output Artifacts

| Artifact | Location |
|----------|----------|
| Code Review Report | `_bmad-output/implementation-artifacts/code-review-${id}.md` |
| Party Mode Review Report | `_bmad-output/implementation-artifacts/party-mode-review-${story_id}.md` |
| Epic Party Mode Review Report | `_bmad-output/implementation-artifacts/epic-*-party-mode-review.md` |
| Retro Notes | `_bmad-output/implementation-artifacts/retro-${id}.md` |
| Initiative State | `_bmad-output/lens-work/initiatives/${id}.yaml` |
| Event Log | `_bmad-output/lens-work/event-log.jsonl` |

---

## Error Handling

| Error | Recovery |
|-------|----------|
| No dev story | Prompt to run /review first |
| P3 not merged | Error with merge gate blocked message |
| Implementation gate not passed | Error â€” run /review first |
| Size validation failed | Error â€” must be on small size for P4 |
| Dirty working directory | Prompt to stash or commit changes first |
| Target repo checkout failed | Check target_repos config, retry |
| Branch creation failed | Check remote connectivity, retry with backoff |
| Dev story compliance gate failed | Resolve constitution FAILs in /review before coding |
| Code review failed | Allow retry or manual review |
| Code review compliance gate failed | Resolve constitutional violations and re-run code review |
| Party mode teardown failed | Address party-mode findings and re-run code review |
| Epic adversarial review failed | Resolve implementation-readiness findings for the epic and re-run code review |
| Epic party mode teardown failed | Address epic party-mode findings and re-run code review |
| State file write failed | Retry (max 3 attempts), then fail with save instructions |

---

## Post-Conditions

- [ ] Working directory clean (all changes committed)
- [ ] On correct branch: `{domain_prefix}/{initiative_id}/{size}-4`
- [ ] Lane validated as "small" for dev phase
- [ ] state.yaml updated with phase p4
- [ ] initiatives/{id}.yaml updated with p4 status and gate entries
- [ ] event-log.jsonl entries appended
- [ ] Dev story loaded and implementation started
- [ ] Dev story compliance gate passed
- [ ] Target repo feature branch checked out
- [ ] Adversarial code review executed
- [ ] Party mode teardown executed and report generated
- [ ] Epic adversarial review executed when epic completion is detected
- [ ] Epic party-mode teardown executed when epic completion is detected
- [ ] All state changes pushed to origin


