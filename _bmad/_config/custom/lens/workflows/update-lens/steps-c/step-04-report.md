---
name: 'step-04-report'
description: 'Write propagation report and finalize updates'
outputFile: '{project-root}/_bmad-output/update-lens-report.md'
---

# Step 4: Report

## Goal
Write a comprehensive report of all propagation actions, sharding outcomes, and hierarchy status. Optionally commit changes and create JIRA tracking items.

## Instructions

### 1. Aggregate All Results
```python
def aggregate_results(preflight, changes, summaries, propagation):
    return {
        "workflow": "update-lens",
        "completed_at": now(),
        "duration_ms": calculate_duration(),
        
        "preflight": preflight,
        "changes_detected": changes,
        "service_aggregation": summaries,
        "propagation": propagation
    }
```

### 2. Generate Markdown Report
```markdown
---
generated: true
generator: lens-sync
workflow: update-lens
timestamp: {ISO8601}
---

# Lens Update Report

**Generated:** {timestamp}
**Duration:** {duration_ms}ms
**Status:** {overall_status}

## Summary

| Metric | Value |
|--------|-------|
| Microservices Changed | {N} |
| Services Aggregated | {N} |
| Domains Updated | {N} |
| Documents Sharded | {N} |
| Total Files Written | {N} |

## Changes Detected

### By Microservice

{For each changed microservice}
#### {ms_name}
- **Domain:** {domain}
- **Service:** {service}
- **Changes:**
{For each change}  - {doc}: {change_type} ({change_summary})
{End for}
{End for}

### By Impact Level

| Level | Count | Microservices |
|-------|-------|---------------|
| High | {N} | {list} |
| Medium | {N} | {list} |
| Low | {N} | {list} |

## Service Aggregation

{For each aggregated service}
### {service_name}
- **Microservices Included:** {list}
- **Documents Generated:**
{For each doc}  - [{doc}]({path})
{End for}
- **Conflicts:** {N}
{If conflicts}
  - {conflict description}
{End if}
{End for}

## Domain Propagation

{For each updated domain}
### {domain_name}
- **Services Included:** {list}
- **Documents Generated:**
{For each doc}  - [{doc}]({path})
{End for}
{End for}

## Sharding

{If shards created}
### Documents Sharded

{For each sharded doc}
#### {original_path}
- **Original Size:** {lines} lines
- **Shards Created:** {N}
- **Index:** [{index_path}]({index_path})
- **Shards:**
{For each shard}  - [{shard.heading}]({shard.path})
{End for}
{End for}
{Else}
No documents required sharding.
{End if}

## Hierarchy Status

```
{domain_name}/
â”œâ”€â”€ overview.md
â”œâ”€â”€ services.md
â”œâ”€â”€ architecture.md
â””â”€â”€ services/
    â”œâ”€â”€ {service_name}/
    â”‚   â”œâ”€â”€ architecture.md
    â”‚   â”œâ”€â”€ api-surface.md
    â”‚   â””â”€â”€ microservices/
    â”‚       â”œâ”€â”€ {ms_name}/
    â”‚       â”‚   â”œâ”€â”€ architecture.md
    â”‚       â”‚   â”œâ”€â”€ api-surface.md
    â”‚       â”‚   â””â”€â”€ ...
```

### Validation

{If hierarchy issues}
âš ï¸ **Issues Detected:**
{For each issue}
- {issue.type}: {issue.description}
{End for}
{Else}
âœ… Hierarchy is fully synchronized.
{End if}

## Files Modified

### Created
{For each created file}
- `{path}` ({size} bytes)
{End for}

### Updated
{For each updated file}
- `{path}` ({change_summary})
{End for}

## Git Status

{If auto_commit enabled}
- **Branch:** {working_branch}
- **Commit:** {commit_sha}
- **Rollback Tag:** {rollback_tag}
{Else}
- **Rollback Tag:** {rollback_tag}
- **Uncommitted Changes:** {N} files
{End if}

## Warnings

{For each warning}
- âš ï¸ {warning}
{End for}

## Next Steps

1. Review generated summaries for accuracy
2. Check sharded documents for proper linking
3. {If uncommitted} Commit changes: `git add . && git commit -m "lens-sync: update propagation"`
4. {If JIRA enabled} Review created JIRA items
5. Run `validate-schema` workflow to verify consistency
```

### 3. Write Report File
```python
def write_report(report_content, output_path):
    report_path = f"{project_root}/_bmad-output/update-lens-report.md"
    
    # Ensure directory exists
    makedirs(dirname(report_path))
    
    # Write report
    write_file(report_path, report_content)
    
    return report_path
```

### 4. Git Commit (if enabled)
```python
def commit_changes(config, report_summary):
    if not config.get("auto_commit"):
        return None
    
    # Stage all lens-sync changes
    run_command("git add docs/lens-sync/")
    
    # Create commit message
    commit_msg = f"""lens-sync: update propagation

{report_summary}

Microservices changed: {N}
Services aggregated: {N}
Domains updated: {N}

Generated by lens-sync workflow
"""
    
    run_command(f'git commit -m "{commit_msg}"')
    
    commit_sha = run_command("git rev-parse HEAD").strip()
    
    return commit_sha
```

### 5. Create JIRA Items (if enabled)
```python
def create_jira_items(config, changes, propagation):
    if not config.get("enable_jira_integration"):
        return []
    
    jira_items = []
    
    # Create tracking issue for significant changes
    if changes["summary"]["total_microservices"] > 0:
        issue = create_jira_issue(
            project=config["jira_project_key"],
            issue_type="Task",
            summary=f"Lens Documentation Update - {date}",
            description=f"""
            Automated lens documentation update.
            
            Changes:
            - {N} microservices updated
            - {N} services aggregated
            - {N} domains propagated
            
            See: {report_path}
            """
        )
        jira_items.append(issue)
    
    # Create issues for detected conflicts
    for conflict in propagation.get("conflicts", []):
        issue = create_jira_issue(
            project=config["jira_project_key"],
            issue_type="Bug",
            summary=f"Lens Conflict: {conflict['type']}",
            description=f"Conflict detected during lens sync: {conflict}"
        )
        jira_items.append(issue)
    
    return jira_items
```

### 6. Update Sidecar State
```yaml
# _memory/bridge-sidecar/bridge-state.md update
last_lens_update:
  timestamp: ISO8601
  commit_sha: string|null
  rollback_tag: string
  
  changes:
    microservices: [list]
    services: [list]
    domains: [list]
    
  report_path: string
  
  status: success|partial|failed
```

### 7. Output Summary for User
```markdown
## Lens Update Complete

**Duration:** {duration}
**Status:** âœ… Success

### Summary
- **{N}** microservices processed
- **{N}** service summaries updated
- **{N}** domain summaries updated
- **{N}** documents sharded

### Report
ðŸ“„ [Full Report]({report_path})

### Git
- Rollback tag: `{rollback_tag}`
{If auto_commit}
- Committed: `{commit_sha}`
- Branch: `{working_branch}`
{Else}
- Changes staged but not committed
- Run: `git add . && git commit -m "lens update"`
{End if}

{If JIRA items}
### JIRA
{For each item}
- [{item.key}]({item.url}): {item.summary}
{End for}
{End if}

### Next Steps
1. Review the generated documentation
2. Run `validate-schema` to verify consistency
3. {If not committed} Commit changes when ready
```

## Edge Cases and Failure Modes

| Condition | Action |
|-----------|--------|
| Report write fails | Log to console, don't fail workflow |
| Git commit fails | Preserve changes, warn user |
| JIRA creation fails | Log error, continue |
| Very large report | Consider summarizing, link to details |
| Partial success | Report both successes and failures |
| No changes to report | Generate minimal report |

## Output
```yaml
report_output:
  report_path: string
  report_size_bytes: N
  
  git:
    commit_sha: string|null
    rollback_tag: string
    branch: string|null
    
  jira:
    items_created: N
    items: [list]
    
  summary:
    microservices_changed: N
    services_aggregated: N
    domains_updated: N
    documents_sharded: N
    files_written: N
    
  status: success|partial|failed
  warnings: [list]
  errors: [list]
```
