---
name: 'step-04-generate-docs'
description: 'Generate docs and update lens metadata'
outputFiles:
  - 'docs/{domain}/{service}/architecture.md'
  - 'docs/{domain}/{service}/api-surface.md'
  - 'docs/{domain}/{service}/data-model.md'
  - 'docs/{domain}/{service}/integration-map.md'
  - 'docs/{domain}/{service}/onboarding.md'
---

# Step 4: Generate Docs

## Goal
Generate BMAD-ready documentation artifacts from analysis results and update lens metadata to track discovery status.

## Output Structure

**IMPORTANT:** Documentation follows the same domain/service structure as TargetProjects:

```
docs/                              # NOT _bmad-output/docs
├── {Domain}/
│   └── {Service}/
│       ├── architecture.md
│       ├── api-surface.md
│       ├── data-model.md
│       ├── integration-map.md
│       └── onboarding.md
└── README.md                      # Index of all generated docs
```

**Example for NorthStarET:**
```
docs/
├── NextGen/
│   ├── NorthStarET/
│   │   ├── architecture.md
│   │   ├── api-surface.md
│   │   └── ...
│   └── NorthStarET.Student/
│       └── ...
├── OldNorthStar/
│   └── OldNorthStar/
│       └── ...
└── README.md
```

## Instructions

### 1. Prepare Output Directory
```bash
# Structure: docs/{domain}/{service}/
output_dir = "docs/{domain}/{service}/"
mkdir -p "{output_dir}"

# Backup existing docs if overwrite policy is "backup"
if docs_exist and policy == "overwrite":
    mv "{output_dir}" "{output_dir}.backup-{timestamp}"
```

### 2. Generate Architecture Document
**File:** `{output_dir}/architecture.md`

```markdown
# {Service Name} Architecture

**Generated:** {ISO8601}  
**Target:** {path}  
**Confidence:** {score}/100

## Overview

{context_summary.business_purpose.summary}

## Technology Stack

| Component | Technology | Version |
|-----------|------------|---------|
| Language | {primary_language} | {version} |
| Framework | {framework} | {version} |
| Runtime | {runtime} | {version} |
| Database | {database_type} | {version} |

## Project Structure

```
{target}/
├── src/
│   ├── controllers/     # API handlers
│   ├── models/          # Data models
│   ├── services/        # Business logic
│   └── utils/           # Utilities
├── tests/               # Test suite
└── config/              # Configuration
```

## Architecture Pattern

**Pattern:** {primary_pattern}  
**Confidence:** {confidence}

{pattern_description}

### Key Design Decisions

1. **{decision_1}**: {rationale}
2. **{decision_2}**: {rationale}

## Dependencies

### Core Dependencies
| Package | Version | Purpose |
|---------|---------|---------|
{for dep in key_dependencies}
| {dep.name} | {dep.version} | {dep.purpose} |
{endfor}

### Infrastructure Dependencies
- **Database ORM:** {orm}
- **Cache:** {cache_type}
- **Message Queue:** {queue_type}

## Security Considerations

- **Authentication:** {auth_method}
- **Authorization:** {authz_type}
- **Input Validation:** {validation_library}

{if security_concerns}
### ⚠️ Security Concerns
{for concern in security_concerns}
- {concern}
{endfor}
{endif}

## Technical Debt

{for debt in debt_signals}
- **{debt.type}**: {debt.description}
{endfor}

---
*Auto-generated by LENS Discovery. Last analyzed: {timestamp}*
```

### 3. Generate API Surface Document
**File:** `{output_dir}/api-surface.md`

```markdown
# {Service Name} API Reference

**Generated:** {ISO8601}  
**Base URL:** `{base_path}`  
**Total Endpoints:** {endpoint_count}

## Authentication

{auth_description}

## Endpoints

{for group in api_groupings}
### {group.purpose}

{for endpoint in group.endpoints}
#### `{endpoint.method} {endpoint.path}`

{endpoint.description}

**Handler:** `{endpoint.handler}` ([{endpoint.file}]({endpoint.file}#L{endpoint.line}))

{if endpoint.parameters}
**Parameters:**
| Name | Location | Type | Required | Description |
|------|----------|------|----------|-------------|
{for param in endpoint.parameters}
| `{param.name}` | {param.type} | {param.data_type} | {param.required} | {param.description} |
{endfor}
{endif}

{if endpoint.body_type}
**Request Body:** `{endpoint.body_type}`
```json
{endpoint.body_example}
```
{endif}

**Response:** `{endpoint.response_type}`
```json
{endpoint.response_example}
```

---
{endfor}
{endfor}

## Error Responses

| Status | Description |
|--------|-------------|
| 400 | Bad Request - Invalid input |
| 401 | Unauthorized - Authentication required |
| 403 | Forbidden - Insufficient permissions |
| 404 | Not Found - Resource doesn't exist |
| 500 | Internal Server Error |

---
*Auto-generated by LENS Discovery. Last analyzed: {timestamp}*
```

### 4. Generate Data Model Document
**File:** `{output_dir}/data-model.md`

```markdown
# {Service Name} Data Models

**Generated:** {ISO8601}  
**Total Models:** {model_count}  
**Database:** {database_type}

## Entity Relationship Diagram

```mermaid
erDiagram
{for model in entity_models}
    {model.name} {
        {for field in model.fields}
        {field.type} {field.name}
        {endfor}
    }
{endfor}
{for rel in relationships}
    {rel.source} {rel.cardinality} {rel.target} : "{rel.name}"
{endfor}
```

## Models

{for model in data_models}
### {model.name}

**Type:** {model.type}  
**File:** [{model.file}]({model.file}#L{model.line})

{if model.type == 'entity'}
| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
{for field in model.fields}
| `{field.name}` | {field.type} | {field.constraints} | {field.description} |
{endfor}

{if model.relationships}
**Relationships:**
{for rel in model.relationships}
- {rel.type} → `{rel.target}` via `{rel.field}`
{endfor}
{endif}
{endif}

{if model.type == 'enum'}
**Values:** {model.values}
{endif}

---
{endfor}

## Database Schema

```sql
{for model in entity_models}
CREATE TABLE {model.table_name} (
{for field in model.fields}
    {field.column_name} {field.sql_type}{field.constraints},
{endfor}
);

{endfor}
```

---
*Auto-generated by LENS Discovery. Last analyzed: {timestamp}*
```

### 5. Generate Integration Map Document
**File:** `{output_dir}/integration-map.md`

```markdown
# {Service Name} Integration Map

**Generated:** {ISO8601}  
**Total Integrations:** {integration_count}

## Integration Diagram

```mermaid
graph LR
{for int in integrations}
    {service_name} --> |{int.protocol}| {int.target}
{endfor}
```

## External Services

{for http_client in integrations.http_clients}
### {http_client.target_service}

**Base URL:** `{http_client.base_url}`  
**Protocol:** HTTP/REST

**Endpoints Called:**
{for endpoint in http_client.endpoints_called}
- `{endpoint}`
{endfor}

**Configuration:** [{http_client.config_file}]({http_client.config_file})

---
{endfor}

## Message Queues

{for queue in integrations.message_queues}
### {queue.type}

**Role:** {queue.role}

{if queue.role in ['producer', 'both']}
**Publishes:**
{for topic in queue.producer_topics}
- `{topic.name}` - {topic.description}
{endfor}
{endif}

{if queue.role in ['consumer', 'both']}
**Consumes:**
{for topic in queue.consumer_topics}
- `{topic.name}` - {topic.handler}
{endfor}
{endif}

---
{endfor}

## Internal Services

{for service in integrations.internal_services}
### {service.name}

**Protocol:** {service.protocol}  
**Purpose:** {service.purpose}

**Endpoints Called:**
{for endpoint in service.endpoints_called}
- `{endpoint}`
{endfor}

---
{endfor}

## Data Flow

```mermaid
sequenceDiagram
{data_flow_diagram}
```

---
*Auto-generated by LENS Discovery. Last analyzed: {timestamp}*
```

### 6. Generate Onboarding Document
**File:** `{output_dir}/onboarding.md`

```markdown
# {Service Name} Onboarding Guide

**Generated:** {ISO8601}  
**Estimated Setup Time:** 15-30 minutes

## Quick Start

### Prerequisites

- {runtime} {min_version}+
- {package_manager}
- {database_type} (local or remote)
{for prereq in prerequisites}
- {prereq}
{endfor}

### Clone & Setup

```bash
# Clone repository
git clone {git_repo} {service_name}
cd {service_name}

# Install dependencies
{install_command}

# Configure environment
cp .env.example .env
# Edit .env with your settings

# Run database migrations
{migration_command}

# Start development server
{start_command}
```

### Verify Installation

```bash
# Health check
curl http://localhost:{port}/health

# Run tests
{test_command}
```

## Development Workflow

### Running Locally

```bash
{dev_command}
```

### Running Tests

```bash
# All tests
{test_command}

# Unit tests only
{unit_test_command}

# Integration tests
{integration_test_command}
```

### Code Style

- **Linter:** {linter}
- **Formatter:** {formatter}

```bash
# Lint
{lint_command}

# Format
{format_command}
```

## Key Contacts

{for contributor in primary_contributors}
- **{contributor.name}** - {contributor.expertise}
{endfor}

## Related Documentation

- [Architecture](./architecture.md)
- [API Reference](./api-surface.md)
- [Data Models](./data-model.md)
- [Integration Map](./integration-map.md)

## Common Issues

{for issue in common_issues}
### {issue.title}

**Symptom:** {issue.symptom}  
**Solution:** {issue.solution}

{endfor}

---
*Auto-generated by LENS Discovery. Last analyzed: {timestamp}*
```

### 7. Update Lens Metadata
Update the service.yaml entry for this microservice:

```yaml
# In service.yaml
microservices:
  - name: {service_name}
    # ... existing fields ...
    
    # Add/update discovery metadata
    discovery:
      last_analyzed: ISO8601
      docs_generated: ISO8601
      confidence_score: N
      docs_path: "{relative_path_to_docs}/"
```

### 8. Update Scout Sidecar
Update `_memory/scout-sidecar/scout-discoveries.md`:

```yaml
discovered_targets:
  - path: string
    discovery_timestamp: ISO8601
    phase: complete
    docs_path: string
    
analysis_results:
  - target: string
    path: string
    summary_path: "_memory/scout-sidecar/analysis/{name}.yaml"
```

### 9. Generate Discovery Summary
If batch discovery, generate roll-up:

**File:** `{docs_output_folder}/lens-sync/discovery-summary.md`

```markdown
# Discovery Summary

**Generated:** {ISO8601}  
**Targets Discovered:** {N}

## Discovered Services

| Service | Type | Endpoints | Models | Integrations |
|---------|------|-----------|--------|--------------|
{for target in discovered}
| [{target.name}](./{target.path}/) | {target.type} | {target.endpoints} | {target.models} | {target.integrations} |
{endfor}

## Cross-Service Insights

### Common Patterns
{common_patterns}

### Integration Graph
```mermaid
{integration_graph}
```

### Recommendations
{recommendations}
```

## Edge Cases and Failure Modes

| Condition | Action |
|-----------|--------|
| Write permission denied | FAIL with path |
| Template rendering fails | Log error, continue with other docs |
| Mermaid too complex | Simplify or split diagrams |
| Very long API list | Paginate or group |
| Missing required data | Insert "Not detected" placeholder |
| File system full | FAIL gracefully with written files list |

## Output
```yaml
generation_result:
  status: success|partial|failed
  target: string
  generated_at: ISO8601
  
  documents:
    - name: "architecture.md"
      path: string
      size_bytes: N
      status: success|failed
    - name: "api-surface.md"
      ...
      
  lens_metadata_updated: boolean
  sidecar_updated: boolean
  
  summary:
    documents_generated: N
    total_size_bytes: N
    
  warnings: [list]
  errors: [list]
```

## Next Step

**CRITICAL:** After completing document generation, you MUST proceed to step-05 to present the deep scan prompt to the user.

**Proceed to:** [./step-05-handoff-scout.md](./step-05-handoff-scout.md)

**DO NOT skip step-05.** The user must be asked whether they want to run a deep scan.
